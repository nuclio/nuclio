# Copyright 2017 The Nuclio Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Release

on:
  release:
    types:
    - created

  # Run Release on push to development for unstable
  push:
    branches:
    - development

  workflow_dispatch:

env:
  REPO: quay.io
  REPO_NAME: nuclio
  CACHE_REPO: ghcr.io
  CACHE_REPO_NAME: ${{ github.repository_owner }}
  DOCKER_BUILDKIT: 1

permissions:

  # Allow the action to upload artifact to releases
  contents: write

  # Allow the action to upload cache images
  packages: write


jobs:
  image_matrix_prep:
    name: Prepare image list
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: print targets
        id: set-matrix
        run: |
          docker_image_rules_json=$(make print-docker-image-rules-json)
          
          # if "handler-builder-golang-onbuild" is in the matrix
          # then ensure "handler-builder-golang-onbuild-alpine" is there too.
          docker_image_rules_json=$(echo $docker_image_rules_json | \
            jq -c 'select(.[].image_rule=="handler-builder-golang-onbuild") += [{"image_rule":"handler-builder-golang-onbuild-alpine"}]')
          
          echo "matrix=$(echo $docker_image_rules_json | jq -c '[.[].image_rule]')" >> $GITHUB_OUTPUT

  release:
    if: github.repository == 'nuclio/nuclio'
    name: Release image (${{ matrix.docker_image_rule }}-${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: image_matrix_prep
    strategy:
      fail-fast: false
      matrix:
        arch:
        - arm64
        - amd64
        docker_image_rule: ${{ fromJson(needs.image_matrix_prep.outputs.matrix) }}
    steps:
    - name: Prepare envs
      run: |
        echo "NUCLIO_DOCKER_REPO=${{ env.REPO }}/${{ env.REPO_NAME }}" >> $GITHUB_ENV
        echo "NUCLIO_CACHE_REPO=${{ env.CACHE_REPO }}/${{ env.CACHE_REPO_NAME }}" >> $GITHUB_ENV
        echo "NUCLIO_ARCH=${{ matrix.arch }}" >> $GITHUB_ENV

    - name: Prepare outputs
      id: release_info
      run: |
        echo "REF_BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
        echo "REF_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Set NUCLIO_LABEL to unstable
      if: github.event_name == 'push'
      run: echo "NUCLIO_LABEL=unstable" >> $GITHUB_ENV

    - name: Set NUCLIO_LABEL to release tag
      if: github.event_name == 'release'
      run: echo "NUCLIO_LABEL=${{ steps.release_info.outputs.REF_TAG }}" >> $GITHUB_ENV

    - uses: actions/checkout@v3

    - name: Freeing up disk space
      run: "${GITHUB_WORKSPACE}/hack/scripts/ci/free-space.sh"

    - uses: actions/setup-go@v3
      with:
        cache: true
        go-version-file: go.mod

    - name: Install QEMU
      if: matrix.arch != 'amd64'
      uses: docker/setup-qemu-action@v2
      with:
        platforms: ${{ matrix.arch }}

    - name: Login to Quay.io
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REPO }}
        username: ${{ secrets.QUAYIO_DOCKER_USERNAME }}
        password: ${{ secrets.QUAYIO_DOCKER_PASSWORD }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.CACHE_REPO }}
        username: ${{ env.CACHE_REPO_NAME }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extending image rules
      run: |
        DOCKER_IMAGES_RULES=()
        
        # if "onbuild-" in "matrix.docker_image_rule", then add "processor" to DOCKER_IMAGES_RULES
        # this is because onbuild images requires processor image
        if [ "${{ matrix.docker_image_rule }}" == *"-onbuild"* ] && [ "${{ matrix.docker_image_rule }}" != *"-golang-"* ]; then \
         DOCKER_IMAGES_RULES+=("processor"); \
        fi
        DOCKER_IMAGES_RULES+=(${{ matrix.docker_image_rule }})
        
        echo "DOCKER_IMAGES_RULES=$(printf "%s " "${DOCKER_IMAGES_RULES[@]}")" >> $GITHUB_ENV

    - name: Build ${{ matrix.docker_image_rule }} image
      run: |
        make pull-docker-images-cache || true
        make docker-images
      env:
        DOCKER_DEFAULT_PLATFORM: linux/${{ matrix.arch }}
        DOCKER_IMAGES_RULES: ${{ env.DOCKER_IMAGES_RULES }}

    - name: Push cache images
      if: env.NUCLIO_LABEL == 'unstable'
      run: make push-docker-images-cache
      env:
        DOCKER_IMAGES_RULES: ${{ env.DOCKER_IMAGES_RULES }}

    - name: Push images
      run: make push-docker-images
      env:
        DOCKER_IMAGES_RULES: ${{ env.DOCKER_IMAGES_RULES }}

    - name: Tag and push stable images
      if: env.NUCLIO_LABEL != 'unstable' && github.event.release.target_commitish == 'master' && contains(env.DOCKER_IMAGES_RULES, 'dashboard')
      run: |
        docker tag "$NUCLIO_DOCKER_REPO/dashboard:$NUCLIO_LABEL-$NUCLIO_ARCH" "$NUCLIO_DOCKER_REPO/dashboard:stable-$NUCLIO_ARCH"
        docker push "$NUCLIO_DOCKER_REPO/dashboard:stable-$NUCLIO_ARCH"
      env:
        DOCKER_IMAGES_RULES: ${{ env.DOCKER_IMAGES_RULES }}

  release_binary:
    if: github.event_name == 'release'
    name: Release Binary ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
        - arm64
        - amd64
    steps:
    - name: Prepare envs
      run: |
        echo "NUCLIO_ARCH=${{ matrix.arch }}" >> $GITHUB_ENV

    - name: Prepare outputs
      id: release_info
      run: |
        echo "REF_BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
        echo "REF_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Set NUCLIO_LABEL to unstable
      if: github.event_name == 'push'
      run: echo "NUCLIO_LABEL=unstable" >> $GITHUB_ENV

    - name: Set NUCLIO_LABEL to release tag
      if: github.event_name == 'release'
      run: echo "NUCLIO_LABEL=${{ steps.release_info.outputs.REF_TAG }}" >> $GITHUB_ENV

    - uses: actions/checkout@v3

    - uses: actions/setup-go@v3
      with:
        cache: true

    - name: Install QEMU
      if: matrix.arch != 'amd64'
      uses: docker/setup-qemu-action@v2
      with:
        platforms: ${{ matrix.arch }}

    - name: Build binaries
      run: |
        NUCLIO_OS=linux make tools
        if [ $NUCLIO_ARCH == "amd64" ]; then \
          NUCLIO_OS=darwin make tools; \
          NUCLIO_OS=windows make tools; \
        fi;
      env:
        NUCLIO_NUCTL_CREATE_SYMLINK: false
        GOPATH: /home/runner/go
        DOCKER_DEFAULT_PLATFORM: linux/${{ matrix.arch }}

    - name: Upload binaries
      uses: AButler/upload-release-assets@v2.0.2
      with:
        files: '/home/runner/go/bin/nuctl-*'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
